# Имя хоста
###################################################################################################
visible_hostname proxy.domain.lol
 
# Порт где слушаем
###################################################################################################
http_port 192.168.1.250:3128
 
# Файл хоста
###################################################################################################
hosts_file /etc/hosts
 
# АвтоДописываемый суффикс
###################################################################################################
append_domain .domain.lol
 
# Письмо вэбмастеру
###################################################################################################
cache_mgr support@domain.lol
 
# Ковыряем ДНС
###################################################################################################
dns_nameservers 127.0.0.1 8.8.8.8
allow_underscore off
dns_retransmit_interval 1 seconds
dns_timeout 2 minutes
dns_defnames off
ignore_unknown_nameservers off
fqdncache_size 8192
 
# Использование кэша
###################################################################################################
cache_dir ufs /home/proxy/cache 8192 48 160
maximum_object_size 1024 MB
minimum_object_size 0,05 KB
cache_swap_high 98
cache_swap_low 90
quick_abort_pct 90
ipcache_size 8192
ipcache_high 98
ipcache_low 80
 
# Использование памяти
###################################################################################################
cache_mem 1024 MB
memory_pools on
memory_pools_limit 512 MB
maximum_object_size_in_memory 64 KB
 
# NTLM аутэнтификация
###################################################################################################
auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp
auth_param ntlm children 300
auth_param ntlm keep_alive off
 
# Пытаемся держать аутентификацию
###################################################################################################
authenticate_ttl 60 minutes
 
# Просто аутэнтификация
###################################################################################################
auth_param basic program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-basic
auth_param basic children 100
auth_param basic realm Welcome to RPOXY.DOMAIN.LOL
auth_param basic credentialsttl 2 hours
auth_param basic casesensitive off
 
# Расположение групп Windows
###################################################################################################
external_acl_type nt_group ipv4 ttl=60 children=100 %LOGIN /usr/lib/squid3/wbinfo_group.pl
 
# Добавляем группу INTERNET-DOMAIN выход в инэт
###################################################################################################
acl inet_users external nt_group internet-domain
 
# Добавляем группу INTERNET-FULL выход в инэт
###################################################################################################
acl inet_ful_users external nt_group internet-full
 
# Добавляем всех аутентифицированных
###################################################################################################
acl AD_auth proxy_auth REQUIRED
 
# Добавляем cписок куда никому нельзя
###################################################################################################
acl hardban     url_regex -i    "/home/proxy/lists/hardban.acl"
 
# Добавляем cписок куда нельзя пользователям
###################################################################################################
acl blacklist   url_regex -i    "/home/proxy/lists/blacklist.acl"
 
# Добавляем cписок банков
###################################################################################################
acl banklist    url_regex -i    "/home/proxy/lists/banklist.acl"
 
# Добавляем пользователей банков банков
###################################################################################################
acl bankusers    src 192.168.1.14   # Банк Клиенты 1
acl bankusers    src 192.168.1.15   # Банк Клиенты 2
acl bankusers    src 192.168.1.19   # Банк Клиенты 3
acl bankusers    src 192.168.1.9    # Банк Клиенты 3
 
# Добавляем cписок IP кому можно
###################################################################################################
# acl ip_allow  src 192.168.1.20    # Тэстовое ведро 1
 
# Добавляем cписок IP кому низя
###################################################################################################
# acl ip_ban    src 192.168.1.21    # Тэстовое ведро 2
 
# Добавляем порты куда можно
###################################################################################################
acl Safe_ports port 443         # ssl
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
 
# Метод
###################################################################################################
acl CONNECT method CONNECT
acl manager proto cache_object
 
# Описываем локалхост
###################################################################################################
acl localhost src 127.0.0.1/32
 
###########################
#   Правила доступа       #
###########################
 
# Пропускаем только безопасные порты
###################################################################################################
http_access     deny    !Safe_ports
 
# Пропускаем локаль для парсера логов
###################################################################################################
http_access     allow   manager     localhost
http_access     deny    manager
 
# Выпускаем банк клиенты
###################################################################################################
http_access     allow   bankusers   banklist
 
# Запрещаем всем список шляпных сайтов
###################################################################################################
http_access     deny    hardban
 
# Разрешаем все группе список IP и блокируем список забаненых
###################################################################################################
# http_access   deny    ip_ban
# http_access   allow   ip_allow
 
# Разрешаем группу INTERNET-DOMAIN на нужные порты и блокируем развлекуху
###################################################################################################
http_access allow   !blacklist  AD_auth
 
# Разрешаем INTERNET-FUL выход по безопасным портам
###################################################################################################
http_access     allow   inet_ful_users
 
#  Срубаем остатки
###################################################################################################
http_access deny    all
 
# Банер заместо рекламы
###################################################################################################
# deny_info     http://proxy.domain.lol/beetle.png          all
 
#########################################
#   Я у мамы кэшотюнер                  #
#########################################
 
# Кэш файлов
###################################################################################################
refresh_pattern -i \.gif$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.png$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.jpg$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.jpeg$ 43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.pdf$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.zip$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.tar$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.gz$   43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.tgz$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.bz2$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.exe$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.prz$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.ppt$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.inf$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.swf$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.mid$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.wav$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.mp3$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
refresh_pattern -i \.ico$  43200 100% 43200 override-lastmod override-expire ignore-reload ignore-no-cache
 
# Кэш прочего
###################################################################################################
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern .               0       80%     14400
